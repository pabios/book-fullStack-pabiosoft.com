Dis-moi â“ â“ comment fait-on pour connecter plusieurs pÃ©riphÃ©riques I2C (SDA/SCL) Ã  mon Arduino ?

Supposons que nous voulions ajouter Ã  notre projet :
- Une pile RTC,
- Plusieurs Ã©crans LCD ou OLED,
- Des capteurs de luminositÃ© TSL2561.

Ou simplement pouvoir rÃ©cupÃ©rer l'heure (10h30) d'une pile RTC et l'afficher dans un petit Ã©cran LCD.

Dans ce cas, le constat devient rapide car la plupart des *Arduino* ne disposent que d'une seule communication I2C (SDA/SCL) ğŸ˜ 

Mais Ã©tant donnÃ© le besoin d'y connecter toujours beaucoup plus de modules I2C, les ArduinoMania nous ont conÃ§u des Multiplexeurs prÃªts Ã  l'emploi tels que le TCA9548a â¤ï¸

## ğŸ”” Petit Rappel de Logique combinatoire 
ğŸ”” Un multiplexeur est un circuit logique qui permet d'aiguiller successivement les entrÃ©es de commande pour les armer *une* aprÃ¨s *une* vers la sortie.

## Fonctionnement du multiplexeur TCA9548A
```ini

| A0 | A1 | A2 | RST | SCL | SDA | GND | VIN |
|----|----|----|-----|-----|-----|-----|-----|
|    |    |    |     |     |     |     |     |
| S0 | S1 | S2 | S3  | S4  | S5  | S6  | S7

```

Ce mux possÃ¨de 3 entrÃ©es de commandes (A0, A1, A2) et 2 entrÃ©es qui permettent d'envoyer le signal sur la bonne sortie. Et 2Â³ = 8 sorties au total.

Donc, c'est assez simple, si tu connectes respectivement a0, a1 et a2 Ã  la masse, tu auras comme adresse de sortie 0x70.

### Exemple:  
  <p>
    Du coup, sur l'image ( on prend l'exemple sur le tca gauche  ğŸ“· ) , nous avons branchÃ© un module IÂ²C Ã  la sortie numÃ©ro 2 et un autre Ã  la sortie 7. Et puisque l'adresse de ce TCA est 0x70 (a1=a2=a0=0), alors pour communiquer avec l'un des modules, il suffit de l'indexer par son adresse (i.e 0x70->2 & 0x70->7).
  </p>
  <p>
    En rÃ©sumÃ©, avec un seul MUX TCA9548A, on pourrait au maximum connecter 8 modules IÂ²C.
  </p>
</div>


# ğŸ˜¡ Tu trouves que 8 pÃ©riphÃ©riques ne sont toujours pas assez ?

Allez â˜•ï¸ sache qu'avec un seul microcontrÃ´leur Arduino, on pourrait connecter jusqu'Ã  64 pÃ©riphÃ©riques I2C en mettant en sÃ©rie 8 modules TCA9548 via l'interface I2C du mÃªme microcontrÃ´leur.
ğŸ’¡ _Les SDA ensemble et les SCL ensemble_ ğŸ’¡


# Connecter plusieurs Mux (TCA9548A)
(voir l'image complÃ¨te ci haut)
 
## Table de vÃ©ritÃ©

```ini

| EntrÃ©es de commande | Sortie IÂ²C |
|--------------------|-------------------------------------|
| A2 | A1 | A0 | Adresse | TCA NÂ° | Nombre de pÃ©riphÃ©rique |
|----|----|----|---------|--------|-----------------------|
| 0  | 0  | 0  | 0x70    | 1      | 8                     |
| 0  | 0  | 1  | 0x71    | 2      | 8                     |
| 0  | 1  | 0  | 0x72    | 3      | 8                     |
| 0  | 1  | 1  | 0x73    | 4      | 8                     |
| 1  | 0  | 0  | 0x74    | 5      | 8                     |
| 1  | 0  | 1  | 0x75    | 6      | 8                     |
| 1  | 1  | 0  | 0x76    | 7      | 8                     |
| 1  | 1  | 1  | 0x77    | 8      | 8                     |
-----------------------------------------------------------
```

 


# RÃ©sumÃ© et exemple d'utilisation
On peut connecter au total 8 modules TCA sur un microcontrÃ´leur tel qu'un Arduino classique. Sachant que chaque module peut connecter en lui seul 8 pÃ©riphÃ©riques I2C tels que des Ã©crans OLED, nous pourrons donc y connecter au total 8*8=64 pÃ©riphÃ©riques I2C. Chaque module aura sa propre adresse pour contrÃ´ler les pÃ©riphÃ©riques enfants.

- Pour cet exemple, nous allons prendre deux modules TCA9548A. Sachant que les adresses vont dÃ©pendre du branchement, si on observe le schÃ©ma, on peut remarquer que :
  * A1=A2=A0 = 0 (pin GND) ==> adresse (0x70)
  * A0=A1=0 ; A2=1 (pin 5V) ===> adresse (0x74)

- Pour cet exemple, je t'ai prÃ©parÃ© un dÃ©pÃ´t GitHub tÃ©lÃ©chargeable via cette adresse :
[https://github.com/pabios/many-tca9548a-mux](https://github.com/pabios/many-tca9548a-mux)


# Utilisation du dÃ©pÃ´t
Pour utiliser ce dÃ©pÃ´t, suivez ces Ã©tapes :
- Clonez ou tÃ©lÃ©chargez le dossier sur votre ordinateur local.

1. Si vous utilisez PlatformIO :
   - Ouvrez le projet avec votre IDE.

Connectez vos modules TCA Ã  lâ€™Arduino Uno/Nano/etc. en suivant le schÃ©ma (ğŸ“· image ci haut ğŸ“·) sur les pins I2C (pins: A4, A5 pour la NANO, 20, 21 pour la MEGA...)  


- Ajoutez les bibliothÃ¨ques dans le fichier `platformio.ini` :

```java
lib_deps =
    adafruit/Adafruit GFX Library@^1.11.5
    adafruit/Adafruit SSD1306@^2.5.7
```


# Le code
Les methodes les plus importantes sont: 
```java

byte Element::selectChannel() const {
    Wire.beginTransmission(this->address); //i.e 0x70 ou 0x74
    Wire.write(1 << this->channel); // 1,2,3....8
    Wire.endTransmission();

    return this->channel;
}
```
La methode `selectChannel()` permet d'indiquer au microcontrÃ´leur Ã  quelle adresse il faut se positionner et Ã  quel canal (ici Ã©cran) il souhaite  ouvrir la communication.


```java

void Element::disableTCA() const{
    Wire.beginTransmission(this->address); //i.e 0x70 ou 0x74
    Wire.write(0);
    Wire.endTransmission();
}
```
La methode `disableTCA()` permet de libÃ©rer l'adresse Ã  la fin de son utilisation.

- Exemple avec le setupOled
```java

void Element::setupOled(){
    this->selectChannel(); // on selectionne le bon  
    this->oled.begin(SSD1306_SWITCHCAPVCC,  0x3C); // neccessaire pour les ecran oled
    this->oled.display();
    this->disableTCA(); // on le libere
}
```

# â˜•ï¸ Bonus
Retrouvez tout le code sur le repo GitHub `pabios/many-mux` :

[https://github.com/pabios/many-mux](https://github.com/pabios/many-tca9548a-mux)

## ğŸ‘¤ Auteur 

| nom     | Contact                                        |
|---------|------------------------------------------------|
| Ismaila | [discord](https://discord.com/invite/TuPCmYD8Ex) |


